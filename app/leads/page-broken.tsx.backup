'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';
import { useAuthStore } from '../../lib/store/auth-simple';
import { ArrowRight } from 'lucide-react';

// Use Next.js dynamic imports instead of React.lazy
const MainSheetPageContent = dynamic(() => import('./status-pages/main-sheet'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const LeadsPageContent = dynamic(() => import('./status-pages/leads'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const WorkingPageContent = dynamic(() => import('./status-pages/working'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const LaterPageContent = dynamic(() => import('./status-pages/later'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const BadPageContent = dynamic(() => import('./status-pages/bad'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const SignedPageContent = dynamic(() => import('./status-pages/signed'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const RoutesPageContent = dynamic(() => import('./routes-page'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});
const RemindersPageContent = dynamic(() => import('./reminders-page'), {
  loading: () => <div className="flex items-center justify-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div></div>,
  ssr: false
});

interface LeadStats {
  totalLeads: number;
  newCount: number;
  leadsCount: number;
  workingCount: number;
  badCount: number;
  laterCount: number;
  signedCount: number;
  callbacksToday: number;
  callbacksUpcoming: number;
}

interface Reminder {
  id: string;
  lead_id: string;
  reminder_type: string;
  priority: string;
  due_date: string;
  title: string;
  description?: string;
  lead_name?: string;
  lead_phone?: string;
}

interface CategorizedReminders {
  overdue: Reminder[];
  today: Reminder[];
  tomorrow: Reminder[];
  upcoming: Reminder[];
  future: Reminder[];
  completed: Reminder[];
}

interface Lead {
  id: string;
  name: string;
  phone?: string;
  date_to_call_back?: string;
  status: string;
}

const TABS = [
  { id: 'dashboard', label: 'Dashboard' },
  { id: 'main-sheet', label: 'Main Sheet' },
  { id: 'leads', label: 'Leads' },
  { id: 'working', label: 'Working On' },
  { id: 'later', label: 'Later Stage' },
  { id: 'bad', label: 'Bad Leads' },
  { id: 'signed', label: 'Signed' },
  { id: 'routes', label: 'Routes' },
  { id: 'reminders', label: 'Reminders' },
] as const;

export default function LeadsPage() {
  const router = useRouter();
  const authStore = useAuthStore();
  const { isAuthenticated, isLoading, token, user } = authStore;
  const [stats, setStats] = useState<LeadStats | null>(null);
  const [reminders, setReminders] = useState<CategorizedReminders | null>(null);
  const [callbackLeads, setCallbackLeads] = useState<Lead[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [mounted, setMounted] = useState(false);

  // Hydrate auth state from localStorage
  useEffect(() => {
    authStore.hydrate();
    setMounted(true);
  }, [authStore]);

  // Read tab from URL after mount (client-side only)
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get('tab');
      if (tab && TABS.some(t => t.id === tab)) {
        setActiveTab(tab);
      }
    }
  }, []);

  useEffect(() => {
    // Only redirect after component is mounted and auth is loaded
    if (mounted && !isLoading) {
      if (!isAuthenticated || !token) {
        router.push('/login');
      }
    }
  }, [mounted, isAuthenticated, isLoading, router, token, user]);

  // Fetch dashboard data
  useEffect(() => {
    if (!token) return;

    const fetchDashboardData = async () => {
      setLoading(true);
      try {
        // Fetch stats
        const statsResponse = await fetch('/api/leads/stats', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (statsResponse.ok) {
          const statsData = await statsResponse.json();
          setStats(statsData);
        }

        // Fetch reminders
        const remindersResponse = await fetch('/api/reminders', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (remindersResponse.ok) {
          const remindersData = await remindersResponse.json();
          setReminders(remindersData.categorized);
        }

        // Fetch leads with callbacks
        const leadsResponse = await fetch('/api/leads?hasCallback=true&limit=100', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (leadsResponse.ok) {
          const leadsData = await leadsResponse.json();
          setCallbackLeads(leadsData.leads || []);
        }
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchDashboardData();
  }, [token]);

  if (!mounted || isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900">
        <div className="text-white text-xl">Loading...</div>
      </div>
    );
  }

  const handleTabChange = (tabId: string) => {
    setActiveTab(tabId);
    // Update URL without page reload
    if (typeof window !== 'undefined') {
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tabId);
      window.history.pushState({}, '', url.toString());
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 py-8 px-4">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="glass-card p-6">
          <h1 className="text-3xl font-bold text-white mb-2">
            Lead Management
          </h1>
          <p className="text-gray-300">
            Track and manage your sales pipeline
          </p>
        </div>

        {/* Tab Navigation */}
        <div className="glass-card p-4">
          <div className="flex flex-wrap gap-2">
            {TABS.map((tab) => (
              <button
                key={tab.id}
                onClick={() => handleTabChange(tab.id)}
                className={`
                  flex-1 min-w-[120px] px-4 py-3 rounded-lg font-medium transition-all
                  ${
                    activeTab === tab.id
                      ? 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg'
                      : 'bg-white/10 text-white hover:bg-white/20'
                  }
                `}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Content */}
        {activeTab === 'dashboard' ? (
          <div className="space-y-6">
            {loading ? (
              <div className="glass-card p-12">
                <div className="flex items-center justify-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400"></div>
                </div>
              </div>
            ) : (
              <>
                {/* Stats Grid */}
                {stats && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button
                      onClick={() => handleTabChange('leads')}
                      className="text-left"
                    >
                      <StatCard
                        title="Leads"
                        value={stats.leadsCount}
                        gradient="from-purple-500 to-purple-600"
                      />
                    </button>
                    <button
                      onClick={() => handleTabChange('working')}
                      className="text-left"
                    >
                      <StatCard
                        title="Working On"
                        value={stats.workingCount}
                        gradient="from-yellow-500 to-orange-600"
                      />
                    </button>
                    <button
                      onClick={() => handleTabChange('later')}
                      className="text-left"
                    >
                      <StatCard
                        title="Later Stage"
                        value={stats.laterCount}
                        gradient="from-indigo-500 to-purple-600"
                      />
                    </button>
                    <button
                      onClick={() => handleTabChange('bad')}
                      className="text-left"
                    >
                      <StatCard
                        title="Bad Leads"
                        value={stats.badCount}
                        gradient="from-red-500 to-red-600"
                      />
                    </button>
                    <button
                      onClick={() => handleTabChange('signed')}
                      className="text-left"
                    >
                      <StatCard
                        title="Signed"
                        value={stats.signedCount}
                        gradient="from-green-500 to-emerald-600"
                      />
                    </button>
                    <button
                      onClick={() => handleTabChange('main-sheet')}
                      className="text-left"
                    >
                      <StatCard
                        title="Main Sheet"
                        value={stats.newCount}
                        gradient="from-gray-500 to-slate-600"
                      />
                    </button>
                    <StatCard
                      title="Total Leads"
                      value={stats.totalLeads}
                      gradient="from-emerald-500 to-emerald-600"
                    />
                    <StatCard
                      title="Callbacks Today"
                      value={stats.callbacksToday}
                      gradient="from-sky-500 to-blue-600"
                    />
                  </div>
                )}

                {/* Upcoming Reminders & Callback Calendar */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Upcoming Reminders */}
                  {reminders && (
                    <div className="glass-card p-6">
                      <h2 className="text-xl font-bold text-white mb-4">
                        Upcoming Reminders
                      </h2>
                      <UpcomingReminders reminders={reminders} />
                    </div>
                  )}

                  {/* Callback Calendar */}
                  <div className="glass-card p-6">
                    <h2 className="text-xl font-bold text-white mb-4">
                      Callback Calendar
                    </h2>
                    <CallbackCalendar leads={callbackLeads} />
                  </div>
                </div>
              </>
            )}
          </div>
        ) : (
          <div className="glass-card p-6">
            {activeTab === 'main-sheet' && <MainSheetPageContent />}
            {activeTab === 'leads' && <LeadsPageContent />}
            {activeTab === 'working' && <WorkingPageContent />}
            {activeTab === 'later' && <LaterPageContent />}
            {activeTab === 'bad' && <BadPageContent />}
            {activeTab === 'signed' && <SignedPageContent />}
            {activeTab === 'routes' && <RoutesPageContent />}
            {activeTab === 'reminders' && <RemindersPageContent />}
          </div>
        )}
      </div>
    </div>
  );
}

// StatCard Component
function StatCard({
  title,
  value,
  gradient
}: {
  title: string;
  value: number;
  gradient: string;
}) {
  return (
    <div className="glass-card p-6 transform hover:scale-105 transition-all duration-200 cursor-pointer relative overflow-hidden group">
      {/* Gradient overlay */}
      <div className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-20 group-hover:opacity-30 transition-opacity`}></div>
      
      {/* Content */}
      <div className="relative z-10">
        <p className="text-sm text-gray-300 mb-1">{title}</p>
        <p className="text-3xl font-bold text-white">{value}</p>
      </div>
      
      {/* Arrow indicator on hover */}
      <div className="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
        <ArrowRight className="w-5 h-5 text-white" />
      </div>
    </div>
  );
}

// UpcomingReminders Component
function UpcomingReminders({ reminders }: { reminders: CategorizedReminders }) {
  const allUpcoming = [
    ...reminders.overdue,
    ...reminders.today,
    ...reminders.tomorrow,
    ...reminders.upcoming
  ].slice(0, 10);

  if (allUpcoming.length === 0) {
    return (
      <p className="text-gray-400 text-center py-8">
        No upcoming reminders
      </p>
    );
  }

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'urgent': return 'text-red-400 bg-red-900/30 border-red-500/50';
      case 'high': return 'text-orange-400 bg-orange-900/30 border-orange-500/50';
      case 'medium': return 'text-yellow-400 bg-yellow-900/30 border-yellow-500/50';
      case 'low': return 'text-green-400 bg-green-900/30 border-green-500/50';
      default: return 'text-gray-400 bg-gray-900/30 border-gray-500/50';
    }
  };

  const getCategoryBadge = (reminder: Reminder) => {
    const dueDate = new Date(reminder.due_date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dueDateOnly = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());

    if (dueDateOnly < today) {
      return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-red-900/50 text-red-300 border border-red-500/50">Overdue</span>;
    } else if (dueDateOnly.getTime() === today.getTime()) {
      return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-blue-900/50 text-blue-300 border border-blue-500/50">Today</span>;
    } else if (dueDateOnly.getTime() === new Date(today.getTime() + 86400000).getTime()) {
      return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-green-900/50 text-green-300 border border-green-500/50">Tomorrow</span>;
    } else {
      return <span className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-900/50 text-gray-300 border border-gray-500/50">Upcoming</span>;
    }
  };

  return (
    <div className="space-y-3 max-h-96 overflow-y-auto">
      {allUpcoming.map((reminder) => (
        <div
          key={reminder.id}
          className="border border-gray-700 rounded-lg p-4 bg-gray-900/30 hover:bg-gray-900/50 transition-colors"
        >
          <div className="flex items-start justify-between mb-2">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <h3 className="font-semibold text-white">{reminder.title}</h3>
                {getCategoryBadge(reminder)}
              </div>
              {reminder.description && (
                <p className="text-sm text-gray-400 mb-2">{reminder.description}</p>
              )}
              {reminder.lead_name && (
                <p className="text-sm text-gray-500">
                  Lead: {reminder.lead_name}
                  {reminder.lead_phone && ` (${reminder.lead_phone})`}
                </p>
              )}
            </div>
            <span className={`px-2 py-1 text-xs font-semibold rounded-full border ${getPriorityColor(reminder.priority)}`}>
              {reminder.priority}
            </span>
          </div>
          <div className="flex items-center gap-4 text-xs text-gray-500">
            <span>üìÖ {new Date(reminder.due_date).toLocaleDateString()}</span>
            <span>üè∑Ô∏è {reminder.reminder_type}</span>
          </div>
        </div>
      ))}
    </div>
  );
}

// CallbackCalendar Component
function CallbackCalendar({ leads }: { leads: Lead[] }) {
  if (leads.length === 0) {
    return (
      <p className="text-gray-400 text-center py-8">
        No scheduled callbacks
      </p>
    );
  }

  // Group leads by date
  const groupedByDate = leads.reduce((acc, lead) => {
    if (!lead.date_to_call_back) return acc;
    
    const date = new Date(lead.date_to_call_back).toLocaleDateString();
    if (!acc[date]) {
      acc[date] = [];
    }
    acc[date].push(lead);
    return acc;
  }, {} as Record<string, Lead[]>);

  // Sort dates
  const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
    return new Date(a).getTime() - new Date(b).getTime();
  });

  const getDateBadge = (dateStr: string) => {
    const date = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    if (dateOnly.getTime() === today.getTime()) {
      return 'bg-blue-900/50 text-blue-300 border-blue-500/50';
    } else if (dateOnly < today) {
      return 'bg-red-900/50 text-red-300 border-red-500/50';
    } else {
      return 'bg-green-900/50 text-green-300 border-green-500/50';
    }
  };

  return (
    <div className="space-y-4 max-h-96 overflow-y-auto">
      {sortedDates.slice(0, 10).map((date) => (
        <div key={date} className="border border-gray-700 rounded-lg p-4 bg-gray-900/30">
          <div className={`inline-block px-3 py-1 rounded-full text-sm font-semibold mb-3 border ${getDateBadge(date)}`}>
            {date}
          </div>
          <div className="space-y-2">
            {groupedByDate[date].map((lead) => (
              <div
                key={lead.id}
                className="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg hover:bg-gray-800/70 transition-colors"
              >
                <div>
                  <p className="font-medium text-white">{lead.name}</p>
                  {lead.phone && (
                    <p className="text-sm text-gray-400">{lead.phone}</p>
                  )}
                </div>
                <span className="px-2 py-1 text-xs font-semibold rounded-full bg-gray-700 border border-gray-600 text-gray-300">
                  {lead.status}
                </span>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}
